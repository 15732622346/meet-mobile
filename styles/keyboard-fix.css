/**
 * 虚拟键盘布局修复样式
 * 解决移动端键盘弹出时页面布局问题
 */

:root {
  --keyboard-height: 0px;
}

/* 键盘弹出时的基本样式 */
body.keyboard-open {
  /* 防止iOS Safari中的弹跳效果 */
  position: relative;
  overflow: hidden !important; /* 防止整体页面滚动 */
  height: 100% !important; /* 确保body高度固定 */
  -webkit-overflow-scrolling: touch;
  /* 防止横向滚动 */
  max-width: 100vw !important;
  width: 100vw !important;
}

/* iOS特殊处理 - 解决横向滚动问题 */
@media screen and (max-width: 500px) {
  html, body {
    max-width: 100% !important;
    overflow-x: hidden !important;
  }
  
  #viewport {
    max-width: 100% !important;
    overflow-x: hidden !important;
  }
  
  /* 强制所有元素不超过视口宽度 */
  * {
    max-width: 100% !important;
    box-sizing: border-box !important;
  }
}

/* 确保固定定位元素在键盘弹出时正确显示 */
body.keyboard-open .chat-input-container,
body.keyboard-open .mobile-footer,
body.keyboard-open [data-fixed-bottom] {
  bottom: var(--keyboard-height) !important;
  position: fixed !important;
  z-index: 100;
  transition: bottom 0.3s ease;
  width: 100% !important; /* 确保占满宽度 */
  left: 0 !important; /* 确保左侧对齐 */
  background-color: #fff; /* 确保有背景色 */
}

/* 确保视频区域在键盘弹出时不被过分挤压 */
body.keyboard-open .video-grid-container,
body.keyboard-open .screen-share-wrapper {
  max-height: 40vh;
  overflow: hidden;
  transition: max-height 0.3s ease;
}

/* 确保聊天区域在键盘弹出时可滚动 */
body.keyboard-open .mobile-chat-messages {
  max-height: calc(60vh - 60px); /* 减去输入框的高度 */
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  /* 防止被页面滚动影响 */
  position: relative;
}

/* 支持VirtualKeyboard API的浏览器特殊处理 */
@supports (bottom: env(keyboard-inset-height)) {
  body.keyboard-open .chat-input-container,
  body.keyboard-open .mobile-footer,
  body.keyboard-open [data-fixed-bottom] {
    bottom: env(keyboard-inset-height, var(--keyboard-height)) !important;
  }
}

/* iOS Safari特殊处理 - 阻止页面上推 */
@supports (-webkit-touch-callout: none) {
  body.keyboard-open {
    /* 防止iOS中内容被键盘推上去 */
    height: 100% !important;
    position: fixed !important;
    width: 100% !important;
    overflow: hidden !important;
  }
  
  body.keyboard-open .main-content {
    /* 允许内容区域滚动而非整个页面 */
    overflow-y: auto;
    height: calc(100% - 60px); /* 减去输入区高度 */
    -webkit-overflow-scrolling: touch;
  }
  
  body.keyboard-open .chat-input-container {
    /* 确保在iOS上输入框始终可见且固定在底部 */
    position: fixed !important;
    bottom: 0 !important;
    left: 0 !important;
    width: 100% !important;
    z-index: 1000 !important;
    padding-bottom: env(safe-area-inset-bottom, 0);
    background-color: white;
    border-top: 1px solid #eee;
    /* 关键修复：防止横向滚动和位置漂移 */
    transform: translateZ(0);
    -webkit-transform: translateZ(0);
  }
  
  /* 确保键盘打开时，输入框内文本位置正确 */
  body.keyboard-open .chat-input-container input,
  body.keyboard-open .chat-input-container textarea {
    position: relative !important;
    transform: none !important;
  }
}

/* 适配不同设备屏幕尺寸 */
@media screen and (max-height: 600px) {
  body.keyboard-open .video-grid-container,
  body.keyboard-open .screen-share-wrapper {
    max-height: 35vh; /* 更小屏幕上减少视频区域高度 */
  }
  
  body.keyboard-open .mobile-chat-messages {
    max-height: calc(55vh - 60px); /* 调整聊天区域高度 */
  }
}

/* 确保所有输入控件在iOS上不会导致页面滚动 */
input, textarea, [contenteditable] {
  /* 防止Safari自动滚动 */
  transform: translateZ(0);
}

/* 输入框聚焦前暂时透明，防止iOS键盘顶起页面的关键类 */
.ios-input-focus {
  animation: blink_input_opacity_to_prevent_scrolling_when_focus 0.01s;
}

/* 透明度闪烁动画 - 防止iOS键盘滚动行为的关键 */
@keyframes blink_input_opacity_to_prevent_scrolling_when_focus {
  0% { opacity: 0; }
  100% { opacity: 1; }
}

/* 登录页风格样式 - 仿照登录页面的处理方式 */
.login-style-input {
  /* 样式基于登录页的输入框 */
  width: 100%;
  padding: 8px 10px;
  border: 1px solid #ccc;
  border-radius: 4px;
  transform: translateZ(0);
}

/* 输入框容器特殊处理 */
.chat-input-container {
  position: relative;
  z-index: 50;
  background-color: #fff;
  width: 100%;
}

/* iOS专用输入框样式 */
@supports (-webkit-touch-callout: none) {
  .chat-input-container.keyboard-visible {
    position: fixed !important;
    bottom: 0;
    left: 0;
    width: 100% !important;
    transform: translateZ(0);
    -webkit-transform: translateZ(0);
    z-index: 10000;
    background-color: white;
    box-shadow: 0 -1px 5px rgba(0,0,0,0.1);
    padding: 8px;
    border-top: 1px solid #eee;
    box-sizing: border-box;
    /* 关键：防止页面上推的opacity动画 */
    animation: blink_input_opacity_to_prevent_scrolling_when_focus 0.01s;
  }
}

/* 添加过渡效果使布局变化更平滑 */
.mobile-video-conference,
.video-grid-container,
.mobile-chat-messages,
.chat-input-container,
.mobile-footer {
  transition: all 0.3s ease;
} 

/* iOS键盘处理专用样式 */
@supports (-webkit-touch-callout: none) {
  /* 添加更强的iOS防滚动处理 */
  body.ios-keyboard-open {
    /* 页面固定，防止上推 */
    position: fixed !important;
    left: 0;
    right: 0;
    width: 100% !important;
    overflow: hidden !important;
    /* 使用GPU加速 */
    transform: translateZ(0);
    -webkit-transform: translateZ(0);
  }
  
  /* 防止横向滚动 */
  body.ios-keyboard-open,
  html {
    max-width: 100vw !important;
    overflow-x: hidden !important;
  }

  /* 输入容器特殊处理 */
  .chat-input-container.keyboard-visible {
    position: fixed !important;
    bottom: 0 !important;
    left: 0 !important;
    width: 100% !important;
    z-index: 10000 !important; /* 超高层级 */
    background-color: white !important;
    box-shadow: 0 -2px 5px rgba(0,0,0,0.1) !important;
    padding: 8px !important;
    box-sizing: border-box !important;
    /* GPU加速 */
    transform: translateZ(0);
    -webkit-transform: translateZ(0);
  }
} 